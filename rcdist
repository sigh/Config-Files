#!/usr/bin/env bash
#
# Distribute $files to $hosts
# 
# rcdist [-d] [base_dir]
#
#   -d       dry run
#   base_dir base directory (default is $HOME)

declare -a hosts files

hosts=(
    zim
)

files=( 
    .bashrc
    .vimrc
    .bash_completion
    .pystartup
    .inputrc
    .screenrc
)

# get options
dry=

while getopts "d" flag ; do
    case $flag in
        d)  dry=1
            ;;
        ?)  exit 1
            ;;
    esac
done
shift $(( $OPTIND-1 ))

base="$1"
if [[ -z "$base" ]] ; then
    base="$HOME"
fi

# change to base directory
cd "$base"

for host in "${hosts[@]}" ; do
    echo "Checking host: $host"
    remote_cksum=$(ssh -C "$host" cksum "${files[@]}" 2> /dev/null)
                              
    # check if error occurred connection to server
    if [[ $? = 255 ]] ; then
        echo "$0: Could not connect to $host" 1>&2
        continue
    fi

    for file in "${files[@]}" ; do
        if [[ ! -r "$file" ]] ; then
            # error if we can't read the file
            echo "$0: Could not read file: $file" 1>&2
        elif ! grep -qx "$(cksum "$file")" <<<"$remote_cksum" ; then
            # if checksum matched, upload
            if [[ -n $dry ]] ; then
                echo "Copy $file"
            else
                scp -C "$file" "$host":"$file"
            fi
        fi
    done
done
